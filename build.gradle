plugins {
  id "org.asciidoctor.convert" version "1.5.3"
  id "com.stehno.gradle.webpreview" version "0.1.1"
}

repositories {
    jcenter()
}

asciidoctor {
    options doctype: 'book'

    backends = ['html5']

    attributes 'source-highlighter'    : 'coderay',
               'coderay-linenums-mode' : 'table',
               icon                    : 'font',
               linkattrs               : true,
               encoding                : 'utf-8'
}

task wrapper(type: Wrapper) {
    gradleVersion = '3.1'
}


task site(group: 'Documentation', description: 'Builds the documentation web site.', dependsOn: ['build', 'vanilla-core:groovydoc', 'vanilla-core:jacocoTestReport', 'asciidoctor']) << {
    logger.info 'Building documentation web site...'

    // copy the templates
    copy {
        from 'src/site'
        into 'build/site'
        include '**/*.html'
        expand([ project_version:project.subprojects[0].version, year:Calendar.instance.get(Calendar.YEAR) ])
    }

    // copy the assets
    copy {
        from 'src/site'
        into 'build/site'
        include '**/css/**'
        include '**/fonts/**'
        include '**/js/**'
    }

    copy {
        from 'vanilla-core/build/docs'
        from 'vanilla-core/build/reports'
        include '**/**'
        into 'build/site'
    }

    copy {
        from 'build/asciidoc'
        include '**/**'
        into 'build/site/guide'
    }
}

task publish(type: GradleBuild) {
    buildFile = 'publish.gradle'
    tasks = ['publishGhPages']
}

webPreview {
    resourceDir = file('build/site')
}
