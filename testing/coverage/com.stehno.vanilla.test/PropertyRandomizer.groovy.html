<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PropertyRandomizer.groovy</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">vanilla-testing</a> &gt; <a href="index.source.html" class="el_package">com.stehno.vanilla.test</a> &gt; <span class="el_source">PropertyRandomizer.groovy</span></div><h1>PropertyRandomizer.groovy</h1><pre class="source lang-java linenums">package com.stehno.vanilla.test

import static com.stehno.vanilla.test.Randomizers.*
import static groovy.lang.Closure.DELEGATE_FIRST

/**
 * Utility for injecting random property values into POJOs and POGOs for testing. This utility may be used directly as a builder or as a DSL for
 * configuring a randomizer.
 *
 * If the target type matches one of the configured class randomizers, that randomizer will be used to randomize the object itself
 * rather than it's internal fields. This allows the randomization of simple types.
 */
class PropertyRandomizer {

<span class="fc" id="L15">    private final List&lt;Class&gt; ignoredTypes = [Class]</span>
<span class="fc" id="L16">    private final List&lt;String&gt; ignoredProperties = []</span>

    @SuppressWarnings('InsecureRandom')
<span class="fc" id="L19">    private final Random rng = new Random()</span>

    private final Class target

    private final Map&lt;Class, Object&gt; classRandomizers = [
<span class="fc" id="L24">        (String)   : forString(),</span>
<span class="fc" id="L25">        (int)      : forInteger(80),</span>
<span class="fc" id="L26">        (Integer)  : forInteger(80),</span>
<span class="fc" id="L27">        (byte)     : forByte(),</span>
<span class="fc" id="L28">        (Byte)     : forByte(),</span>
<span class="fc" id="L29">        (short)    : forShort(),</span>
<span class="fc" id="L30">        (Short)    : forShort(),</span>
<span class="fc" id="L31">        (char)     : forChar(),</span>
<span class="fc" id="L32">        (Character): forChar(),</span>
<span class="fc" id="L33">        (long)     : forLong(),</span>
<span class="fc" id="L34">        (Long)     : forLong(),</span>
<span class="fc" id="L35">        (boolean)  : forBoolean(),</span>
<span class="fc" id="L36">        (Boolean)  : forBoolean(),</span>
<span class="fc" id="L37">        (float)    : forFloat(),</span>
<span class="fc" id="L38">        (Float)    : forFloat(),</span>
<span class="fc" id="L39">        (double)   : forDouble(),</span>
<span class="fc" id="L40">        (Double)   : forDouble()</span>
    ]

    private final Map&lt;String, Object&gt; nameRandomizers = [:]

    private PropertyRandomizer(Class target) {
<span class="fc" id="L46">        this.target = target</span>
    }

    /**
     * Creates a new randomizer for the provided target class. If a closure parameter is provided, it will be used to configure the randomizer.
     * The returned PropertyRandomizer may continue to be configured with or without a configuration closure.
     *
     * @param target the class to be provided random property values
     * @param closure the closure containing the DSL-style randomizer configuration
     * @return the configured PropertyRandomizer for use or further configuration.
     */
    static PropertyRandomizer randomize(Class target, @DelegatesTo(value = PropertyRandomizer, strategy = DELEGATE_FIRST) Closure closure = null) {
<span class="fc" id="L58">        def rando = new PropertyRandomizer(target)</span>

<span class="fc bfc" id="L60" title="All 2 branches covered.">        if (closure) {</span>
<span class="fc" id="L61">            closure.delegate = rando</span>
<span class="fc" id="L62">            closure.resolveStrategy = DELEGATE_FIRST</span>
<span class="fc" id="L63">            closure()</span>
        }

<span class="pc" id="L66">        rando</span>
    }

    /**
     * Configures the randomizer with property types which will be ignored by the randomization.
     *
     * @param types the property types to be ignored
     * @return the PropertyRandomizer instance
     */
    PropertyRandomizer ignoringTypes(Class... types) {
<span class="nc" id="L76">        ignoredTypes.addAll(types)</span>
<span class="nc" id="L77">        this</span>
    }

    /**
     * Configures the randomizer with the names of properties to be ignored by the randomization.
     *
     * @param props the names of properties to be ignored
     * @return the PropertyRandomizer instance
     */
    PropertyRandomizer ignoringProperties(String... props) {
<span class="fc" id="L87">        ignoredProperties.addAll(props)</span>
<span class="pc" id="L88">        this</span>
    }

    /**
     * Configures specific randomizers (Closures) to be used for specific property types.
     * The provided randomizer configurations will be appended (and may overwrite) the default randomizer
     * set; however, if the clean parameter is specified as &quot;true&quot;, the provided map of randomizers will
     * be used as the inclusive configuration set.
     *
     * The randomizer closure may accept zero, one, or two parameters - where the parameters are the random number generator (Random) as the first
     * parameter, and the instance being populated as the second parameter.
     *
     * @param randomizers the type randomizers to be used
     * @param clean whether or not to replace all existing randomizers with the provided set (defaults to false)
     * @return the PropertyRandomizer instance
     */
    PropertyRandomizer typeRandomizers(Map&lt;Class, Object&gt; randomizers, boolean clean = false) {
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        if (clean) classRandomizers.clear()</span>
<span class="fc" id="L106">        classRandomizers.putAll(randomizers)</span>
<span class="pc" id="L107">        this</span>
    }

    PropertyRandomizer typeRandomizer(Class type, Object randomizer) {
<span class="fc" id="L111">        classRandomizers.put(type, randomizer)</span>
<span class="pc" id="L112">        this</span>
    }

    /**
     * Configures randomizers for specific properties of the object being randomized. Specific property randomizations
     * will override any configured type randomizers.
     *
     * The randomizer closure may accept zero, one, or two parameters - where the parameters are the random number generator (Random) as the first
     * parameter, and the instance being populated as the second parameter.
     *
     * @param randomizers the property randomizers to be used
     * @return the PropertyRandomizer instance
     */
    PropertyRandomizer propertyRandomizers(Map&lt;String, Object&gt; randomizers) {
<span class="fc" id="L126">        nameRandomizers.putAll(randomizers)</span>
<span class="pc" id="L127">        this</span>
    }

    PropertyRandomizer propertyRandomizer(String name, Object randomizer) {
<span class="fc" id="L131">        nameRandomizers.put(name, randomizer)</span>
<span class="pc" id="L132">        this</span>
    }

    /**
     * Used to retrieve a single randomized instance of the target class. Each call to this method will
     * return a new randomized object.
     *
     * The randomized instance of the object will also be convertible to a Map using the &quot;asType(Class)&quot; method or using the
     * &quot;as Map&quot; operation. This map will be immutable and only contain the randomized properties. Simple types whose class
     * randomizers are found directly in the configured randomizers will not have this added functionality.
     *
     * @return a single randomized instance of the target class
     */
    def one() {
<span class="fc" id="L146">        def inst = target.newInstance()</span>

<span class="fc bfc" id="L148" title="All 2 branches covered.">        if (classRandomizers.containsKey(target)) {</span>
<span class="fc" id="L149">            inst = callRandomizer(inst, classRandomizers[target])</span>

        } else {
<span class="fc" id="L152">            def props = [:]</span>

<span class="fc" id="L154">            target.metaClass.properties.each { p -&gt;</span>
<span class="pc bpc" id="L155" title="19 of 34 branches missed.">                if (p.setter &amp;&amp; !(p.type in ignoredTypes) &amp;&amp; !(p.name in ignoredProperties)) {</span>
<span class="pc bpc" id="L156" title="2 of 4 branches missed.">                    def randomizer = nameRandomizers[p.name] ?: classRandomizers[p.type]</span>

<span class="pc bpc" id="L158" title="6 of 8 branches missed.">                    if (!randomizer) throw new IllegalStateException(&quot;No randomizer configured for property (${p.type.simpleName} ${p.name}).&quot;)</span>

<span class="pc" id="L160">                    def value = callRandomizer(inst, randomizer)</span>
<span class="pc" id="L161">                    inst[p.name] = value</span>
<span class="pc" id="L162">                    props[p.name] = value</span>
                }
            }

<span class="fc" id="L166">            def originalAsType = target.metaClass.getMetaMethod('asType', [Class] as Class[])</span>

<span class="fc" id="L168">            inst.metaClass.asType = { Class type -&gt;</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">                if (type.isAssignableFrom(Map)) {</span>
<span class="pc" id="L170">                    return props.asImmutable()</span>
                } else {
<span class="nc" id="L172">                    return originalAsType.invoke(delegate)</span>
                }
            }
        }

<span class="pc" id="L177">        inst</span>
    }

    private callRandomizer(instance, Object randomizer) {
<span class="fc bfc" id="L181" title="All 2 branches covered.">        if (randomizer instanceof PropertyRandomizer) {</span>
<span class="pc" id="L182">            return randomizer.one()</span>

<span class="pc bpc" id="L184" title="1 of 2 branches missed.">        } else if (randomizer instanceof Closure) {</span>
<span class="fc" id="L185">            switch (randomizer.maximumNumberOfParameters) {</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">                case 2:</span>
<span class="nc" id="L187">                    return randomizer.call(rng, instance)</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">                case 1:</span>
<span class="fc" id="L189">                    return randomizer.call(rng)</span>
                default:
<span class="nc" id="L191">                    return randomizer.call()</span>
            }

        } else {
<span class="nc" id="L195">            throw new IllegalArgumentException(&quot;Randomizers of type ${randomizer.class} are not supported.&quot;)</span>
        }
    }

    /**
     * Used to retrieve multiple randomized instances of the target class (each being different).
     *
     * @param x the number of random instances to be retrieved
     * @return a List of randomized instances of the target class
     */
    List times(int x) {
<span class="fc" id="L206">        def items = []</span>
<span class="fc" id="L207">        x.times {</span>
<span class="pc" id="L208">            items &lt;&lt; one()</span>
        }
<span class="pc" id="L210">        items</span>
    }

    /**
     * An override of the multiplication operation as an alias to the &quot;times(int)&quot; method.
     *
     * @param x the number of random instances to be retrieved
     * @return a List of randomized instances of the target class
     */
    List multiply(int x) {
<span class="pc bpc" id="L220" title="2 of 4 branches missed.">        times(x)</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>