<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PropertyRandomizer.groovy</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">vanilla-core</a> &gt; <a href="index.source.html" class="el_package">com.stehno.vanilla.test</a> &gt; <span class="el_source">PropertyRandomizer.groovy</span></div><h1>PropertyRandomizer.groovy</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2016 Christopher J. Stehno &lt;chris@stehno.com&gt;
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.stehno.vanilla.test

import java.util.concurrent.ThreadLocalRandom

import static com.stehno.vanilla.test.Randomizers.*
import static groovy.lang.Closure.DELEGATE_FIRST

/**
 * Utility for injecting random property values into POJOs and POGOs for testing. This utility may be used directly as a builder or as a DSL for
 * configuring a randomizer.
 *
 * If the target type matches one of the configured class randomizers, that randomizer will be used to randomize the object itself
 * rather than it's internal fields. This allows the randomization of simple types.
 *
 * An example usage, would be similar to the following:
 *
 * &lt;pre&gt;&lt;code&gt;
 * def rando = randomize(Person){
 *     typeRandomizers(
 *         (Date):{ new Date() },
 *         (Pet): { randomize(Pet).one() }
 *     )
 * }
 *
 * def instance = rando.one()
 * &lt;/code&gt;&lt;/pre&gt;
 *
 * More information may be found in my blog post,
 * &quot;&lt;a href=&quot;http://coffeaelectronica.com/blog/2015/property-randomization.html&quot;&gt;Property Randomization for Testing&lt;/a&gt;&quot;
 */
class PropertyRandomizer implements RandomizerDsl {

<span class="fc" id="L48">    private final List&lt;Class&gt; ignoredTypes = [Class]</span>
<span class="fc" id="L49">    private final List&lt;String&gt; ignoredProperties = []</span>

    @SuppressWarnings('InsecureRandom')
<span class="fc" id="L52">    private final Random rng = ThreadLocalRandom.current()</span>
    private final Class target

    private final Map&lt;Class, Object&gt; classRandomizers = [
<span class="fc" id="L56">        (String)   : forString(),</span>
<span class="fc" id="L57">        (int)      : forInteger(),</span>
<span class="fc" id="L58">        (Integer)  : forInteger(),</span>
<span class="fc" id="L59">        (byte)     : forByte(),</span>
<span class="fc" id="L60">        (Byte)     : forByte(),</span>
<span class="fc" id="L61">        (short)    : forShort(),</span>
<span class="fc" id="L62">        (Short)    : forShort(),</span>
<span class="fc" id="L63">        (char)     : forChar(),</span>
<span class="fc" id="L64">        (Character): forChar(),</span>
<span class="fc" id="L65">        (long)     : forLong(),</span>
<span class="fc" id="L66">        (Long)     : forLong(),</span>
<span class="fc" id="L67">        (boolean)  : forBoolean(),</span>
<span class="fc" id="L68">        (Boolean)  : forBoolean(),</span>
<span class="fc" id="L69">        (float)    : forFloat(),</span>
<span class="fc" id="L70">        (Float)    : forFloat(),</span>
<span class="fc" id="L71">        (double)   : forDouble(),</span>
<span class="fc" id="L72">        (Double)   : forDouble(),</span>
<span class="fc" id="L73">        (Date)     : forDate()</span>
    ]

    private final Map&lt;String, Object&gt; nameRandomizers = [:]

    private PropertyRandomizer(Class target) {
<span class="fc" id="L79">        this.target = target</span>
    }

    /**
     * Creates a new randomizer for the provided target class. If a closure parameter is provided, it will be used to configure the randomizer.
     * The returned PropertyRandomizer may continue to be configured with or without a configuration closure.
     *
     * @param target the class to be provided random property values
     * @param closure the closure containing the DSL-style randomizer configuration
     * @return the configured PropertyRandomizer for use or further configuration.
     */
    static PropertyRandomizer randomize(Class target, @DelegatesTo(value = RandomizerDsl, strategy = DELEGATE_FIRST) Closure closure = null) {
<span class="fc" id="L91">        def rando = new PropertyRandomizer(target)</span>

<span class="fc bfc" id="L93" title="All 2 branches covered.">        if (closure) {</span>
<span class="fc" id="L94">            closure.delegate = rando</span>
<span class="fc" id="L95">            closure.resolveStrategy = DELEGATE_FIRST</span>
<span class="fc" id="L96">            closure()</span>
        }

<span class="pc" id="L99">        rando</span>
    }

    /**
     * Configures the randomizer with property types which will be ignored by the randomization.
     *
     * @param types the property types to be ignored
     * @return the PropertyRandomizer instance
     */
    PropertyRandomizer ignoringTypes(Class... types) {
<span class="nc" id="L109">        ignoredTypes.addAll(types)</span>
<span class="nc" id="L110">        this</span>
    }

    /**
     * Configures the randomizer with the names of properties to be ignored by the randomization.
     *
     * @param props the names of properties to be ignored
     * @return the PropertyRandomizer instance
     */
    PropertyRandomizer ignoringProperties(String... props) {
<span class="fc" id="L120">        ignoredProperties.addAll(props)</span>
<span class="pc" id="L121">        this</span>
    }

    /**
     * Configures specific randomizers (Closures) to be used for specific property types.
     * The provided randomizer configurations will be appended (and may overwrite) the default randomizer
     * set; however, if the clean parameter is specified as &quot;true&quot;, the provided map of randomizers will
     * be used as the inclusive configuration set.
     *
     * The randomizer closure may accept zero, one, or two parameters - where the parameters are the random number generator (Random) as the first
     * parameter, and the instance being populated as the second parameter.
     *
     * @param randomizers the type randomizers to be used
     * @param clean whether or not to replace all existing randomizers with the provided set (defaults to false)
     * @return the PropertyRandomizer instance
     */
    PropertyRandomizer typeRandomizers(Map&lt;Class, Object&gt; randomizers, boolean clean = false) {
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">        if (clean) {</span>
<span class="nc" id="L139">            classRandomizers.clear()</span>
        }

<span class="fc" id="L142">        classRandomizers.putAll(randomizers)</span>
<span class="pc" id="L143">        this</span>
    }

    PropertyRandomizer typeRandomizer(Class type, Object randomizer) {
<span class="fc" id="L147">        classRandomizers.put(type, randomizer)</span>
<span class="pc" id="L148">        this</span>
    }

    /**
     * Configures randomizers for specific properties of the object being randomized. Specific property randomizations
     * will override any configured type randomizers.
     *
     * The randomizer closure may accept zero, one, or two parameters - where the parameters are the random number generator (Random) as the first
     * parameter, and the property map of the instance being populated as the second parameter.
     *
     * @param randomizers the property randomizers to be used
     * @return the PropertyRandomizer instance
     */
    PropertyRandomizer propertyRandomizers(Map&lt;String, Object&gt; randomizers) {
<span class="fc" id="L162">        nameRandomizers.putAll(randomizers)</span>
<span class="pc" id="L163">        this</span>
    }

    PropertyRandomizer propertyRandomizer(String name, Object randomizer) {
<span class="fc" id="L167">        nameRandomizers.put(name, randomizer)</span>
<span class="pc" id="L168">        this</span>
    }

    /**
     * Used to retrieve a single randomized instance of the target class. Each call to this method will
     * return a new randomized object.
     *
     * The randomized instance of the object will also be convertible to a Map using the &quot;asType(Class)&quot; method or using the
     * &quot;as Map&quot; operation. This map will be immutable and only contain the randomized properties. Simple types whose class
     * randomizers are found directly in the configured randomizers will not have this added functionality.
     *
     * The configured property randomizers may be overridden within the scope of one call by supplying an overrides map with the property and its
     * randomizer override.
     *
     * @param overrides an optional map of property randomizer overrides (property name to randomizer)
     * @return a single randomized instance of the target class
     */
    def one(Map&lt;String, Object&gt; overrides = [:]) {
<span class="fc" id="L186">        def inst</span>

<span class="fc bfc" id="L188" title="All 2 branches covered.">        if (classRandomizers.containsKey(target)) {</span>
<span class="fc" id="L189">            inst = callRandomizer(null, classRandomizers[target])</span>

        } else {
<span class="fc" id="L192">            def instMap = [:]</span>

            // apply any call-based property overrides
<span class="fc" id="L195">            def activePropertyRandomizers = nameRandomizers + overrides</span>

<span class="fc" id="L197">            target.metaClass.properties.each { MetaProperty p -&gt;</span>
<span class="pc bpc" id="L198" title="21 of 42 branches missed.">                if ((isImmutable() || p.setter) &amp;&amp; !(p.type in ignoredTypes) &amp;&amp; !(p.name in ignoredProperties)) {</span>
<span class="pc bpc" id="L199" title="2 of 4 branches missed.">                    def randomizer = activePropertyRandomizers[p.name] ?: classRandomizers[p.type]</span>

<span class="pc bpc" id="L201" title="6 of 8 branches missed.">                    if (!randomizer) {</span>
<span class="nc" id="L202">                        throw new IllegalStateException(&quot;No randomizer configured for property (${p.type.simpleName} ${p.name}).&quot;)</span>
                    }

<span class="pc" id="L205">                    def value = callRandomizer(instMap, randomizer)</span>
<span class="pc" id="L206">                    instMap[p.name] = value</span>
                }
            }

<span class="fc" id="L210">            inst = target.newInstance(instMap)</span>

<span class="fc" id="L212">            def originalAsType = target.metaClass.getMetaMethod('asType', [Class] as Class[])</span>

<span class="fc" id="L214">            inst.metaClass.asType = { Class type -&gt;</span>
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">                if (type.isAssignableFrom(Map)) {</span>
<span class="fc" id="L216">                    return instMap.asImmutable()</span>
                }
<span class="nc" id="L218">                return originalAsType.invoke(delegate, [type] as Object[])</span>
            }
        }

<span class="pc" id="L222">        inst</span>
    }

    private boolean isImmutable() {
<span class="pc" id="L226">        target.metaClass.delegate.theClass.getAnnotation(groovy.transform.Immutable)</span>
    }

    private callRandomizer(instance, Object randomizer) {
<span class="fc bfc" id="L230" title="All 2 branches covered.">        if (randomizer instanceof PropertyRandomizer) {</span>
<span class="pc" id="L231">            return randomizer.one()</span>

<span class="pc bpc" id="L233" title="1 of 2 branches missed.">        } else if (randomizer instanceof Closure) {</span>
<span class="fc" id="L234">            switch (randomizer.maximumNumberOfParameters) {</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">                case 2:</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">                    return randomizer.call(rng, instance != null ? instance : [:])</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">                case 1:</span>
<span class="fc" id="L238">                    return randomizer.call(rng)</span>
                default:
<span class="nc" id="L240">                    return randomizer.call()</span>
            }

        } else {
<span class="nc" id="L244">            throw new IllegalArgumentException(&quot;Randomizers of type ${randomizer.class} are not supported.&quot;)</span>
        }
    }

    /**
     * Used to retrieve multiple randomized instances of the target class (each being different).
     *
     * @param x the number of random instances to be retrieved
     * @return a List of randomized instances of the target class
     */
    List times(int x) {
<span class="fc" id="L255">        def items = []</span>
<span class="fc" id="L256">        x.times {</span>
<span class="pc" id="L257">            items &lt;&lt; one()</span>
        }
<span class="pc" id="L259">        items</span>
    }

    /**
     * An override of the multiplication operation as an alias to the &quot;times(int)&quot; method.
     *
     * @param x the number of random instances to be retrieved
     * @return a List of randomized instances of the target class
     */
    List multiply(int x) {
<span class="pc bpc" id="L269" title="2 of 4 branches missed.">        times(x)</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>